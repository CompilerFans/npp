# NPP测试框架总览

## 测试框架架构图

```
                        OpenNPP测试框架总体架构
    ┌──────────────────────────────────────────────────────────────────┐
    │                        测试层级结构                              │
    └──────────────────────────────────────────────────────────────────┘
                                    │
        ┌───────────────────────────┼───────────────────────────┐
        │                           │                           │
   ┌────▼────┐                 ┌────▼────┐                 ┌────▼────┐
   │ 单元测试 │                 │ 集成测试 │                 │ 验证测试 │
   │Unit Test│                 │Int. Test│                 │Val. Test│
   └─────────┘                 └─────────┘                 └─────────┘
        │                           │                           │
        ▼                           ▼                           ▼
┌──────────────┐            ┌──────────────┐            ┌──────────────┐
│   功能验证    │            │   模块集成    │            │  三方对比     │
│ ·Core函数    │            │ ·完整工作流   │            │ ·OpenNPP     │
│ ·内存管理    │            │ ·错误处理     │            │ ·NVIDIA NPP  │
│ ·基础运算    │            │ ·性能测试     │            │ ·CPU参考     │
└──────────────┘            └──────────────┘            └──────────────┘
```

## 三方验证系统详细流程

```
测试数据准备阶段
    │
    ├── 创建测试图像数据
    │   ├── 固定模式数据 (用于确定性测试)
    │   ├── 随机数据 (用于鲁棒性测试)  
    │   └── 边界条件数据 (用于极限测试)
    │
    ├── 分配内存缓冲区
    │   ├── 主机内存 (Host Memory)
    │   └── 设备内存 (Device Memory with Pitch)
    │
    └── 数据传输到GPU
        └── cudaMemcpy2D (Host → Device)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

并行执行三种实现
    │
    ├─── OpenNPP执行路径 ────────────────┐
    │    │                              │
    │    ├── 调用OpenNPP函数              │
    │    ├── CUDA Kernel执行             │     结果A
    │    └── 设备→主机数据传输            │     (我们的实现)
    │                                   │
    ├─── NVIDIA NPP执行路径 ─────────────┤
    │    │                              │
    │    ├── 调用NVIDIA NPP函数          │     结果B  
    │    ├── 闭源Kernel执行              │     (官方标准)
    │    └── 设备→主机数据传输            │
    │                                   │
    └─── CPU参考执行路径 ────────────────┘
         │                              
         ├── 纯CPU算法实现                      结果C
         └── 主机内存直接计算                   (独立验证)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

三方结果对比验证
    │
    ├── 数值精度对比
    │   ├── 整数类型: 逐位精确匹配 (A[i] == B[i] == C[i])
    │   └── 浮点类型: 容差范围匹配 (|A[i]-B[i]| < ε)
    │
    ├── 错误状态对比  
    │   ├── 返回值检查: NPP_NO_ERROR vs 错误码
    │   └── 异常处理: 相同的错误边界
    │
    └── 性能特征对比
        ├── 内存使用模式: Pitch对齐、步长一致
        └── CUDA执行特征: 流管理、同步行为

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

测试结果报告生成
    │
    ├── 实时进度显示
    │   ├── "测试 nppiAddC_8u_C1RSfs... ✓ 通过"
    │   └── "NVIDIA NPP对比: ✓ 通过"  
    │
    ├── 汇总统计表格
    │   ┌─────────────┬─────────┬──────────┬─────────┬───────┐
    │   │ Test Name   │ OpenNPP │NVIDIA NPP│ CPU Ref │ Match │
    │   ├─────────────┼─────────┼──────────┼─────────┼───────┤
    │   │ AddC_8u_C1  │  PASS   │   PASS   │  PASS   │  YES  │
    │   │ AddC_16u_C1 │  PASS   │   PASS   │  PASS   │  YES  │
    │   └─────────────┴─────────┴──────────┴─────────┴───────┘
    │
    └── 详细诊断信息
        ├── 不匹配像素位置和数值
        ├── 最大/平均误差统计  
        └── 性能差异分析
```

## 测试数据流转图

```
                          测试数据生命周期
    
    创建阶段              传输阶段              处理阶段              验证阶段
        │                    │                    │                    │
        ▼                    ▼                    ▼                    ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  主机测试数据    │  │   设备内存      │  │   GPU并行处理   │  │   结果对比      │
│                │  │                │  │                │  │                │
│ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │
│ │   模式数据   │ │  │ │  Pitched    │ │  │ │ OpenNPP     │ │  │ │  数值精度   │ │
│ │ Pattern Data│ │  │ │   Memory    │ │  │ │  Kernels    │ │  │ │ Validation  │ │
│ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │
│        │        │  │        │        │  │        │        │  │        │        │
│ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │
│ │   随机数据   │ │──┼─│ Multi-Chan  │ │──┼─│ NVIDIA NPP  │ │──┼─│  状态检查   │ │
│ │ Random Data │ │  │ │   Layout    │ │  │ │   Kernels   │ │  │ │Status Check │ │
│ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │
│        │        │  │        │        │  │        │        │  │        │        │
│ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────┐ │
│ │   边界数据   │ │  │ │   ROI设置   │ │  │ │CPU参考实现  │ │  │ │  性能对比   │ │
│ │Boundary Data│ │  │ │ ROI Config  │ │  │ │CPU Reference│ │  │ │Performance  │ │
│ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────┘ │
└─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘
        │                    │                    │                    │
        ▼                    ▼                    ▼                    ▼
   固定+随机+边界        Pitch对齐内存       三路并行执行         精度+状态+性能
```

## 测试覆盖矩阵

```
                              NPP功能测试覆盖矩阵
    
    ┌─────────────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐
    │   函数类型   │ 8u  │ 8s  │ 16u │ 16s │ 32u │ 32s │ 32f │ 64f │状态 │
    ├─────────────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┼─────┤
    │NPP Core     │  -  │  -  │  -  │  -  │  -  │  -  │  -  │  -  │ ✅  │
    │Memory Mgmt  │ ✅  │  -  │ ✅  │ ✅  │  -  │  -  │ ✅  │  -  │ ✅  │
    │AddC         │ ✅  │  -  │ ✅  │ ✅  │  -  │  -  │ ✅  │  -  │ ✅  │
    │SubC         │ ✅  │  -  │ ✅  │ ✅  │  -  │  -  │ ✅  │  -  │ ✅  │
    │MulC         │ ✅  │  -  │ ✅  │ ✅  │  -  │  -  │ ✅  │  -  │ ✅  │
    │DivC         │ ✅  │  -  │ ✅  │ ✅  │  -  │  -  │ ✅  │  -  │ ✅  │
    │Multi-Chan   │ ✅  │  -  │  ⏳ │  ⏳ │  -  │  -  │  ⏳ │  -  │ ⏳  │
    │In-Place     │ ✅  │  -  │  ⏳ │  ⏳ │  -  │  -  │  ⏳ │  -  │ ⏳  │
    │Image-to-Img │  ⏳ │  -  │  ⏳ │  ⏳ │  -  │  -  │  ⏳ │  -  │ ⏳  │
    └─────────────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘
    
    图例: ✅ 已实现并测试  ⏳ 计划中  - 暂不支持
```

## 验证策略层次

```
                            验证严格性层次
    
    Level 4: 生产就绪验证 ────────────────────────────┐
    │                                              │
    │ • 大规模随机数据测试                          │
    │ • 性能基准测试                                │ 
    │ • 内存泄漏检测                                │
    │ • 多GPU并发测试                               │
    └──────────────────────────────────────────────┘
                              │
    Level 3: 全面功能验证 ────────────────────────────┐
    │                                              │
    │ • 所有数据类型覆盖                            │
    │ • 边界条件测试                                │
    │ • 错误处理验证                                │
    │ • 多通道图像测试                              │
    └──────────────────────────────────────────────┘
                              │
    Level 2: 三方对比验证 ────────────────────────────┐
    │                                              │
    │ • OpenNPP vs NVIDIA NPP 数值对比             │
    │ • OpenNPP vs CPU参考 逻辑验证                │
    │ • NVIDIA NPP vs CPU参考 标准确认             │
    │ • 状态码一致性检查                            │
    └──────────────────────────────────────────────┘
                              │
    Level 1: 基础功能验证 ────────────────────────────┐
    │                                              │
    │ • 函数正常执行 (NPP_NO_ERROR)                │
    │ • 基本输入输出验证                            │
    │ • 内存分配成功                                │
    │ • CUDA设备可用性                             │
    └──────────────────────────────────────────────┘
```

此测试框架设计确保了OpenNPP项目的:
- **🎯 100%兼容性**: 与NVIDIA NPP逐位匹配
- **🔍 全面覆盖**: 多层次验证策略  
- **⚡ 高效执行**: 并行测试架构
- **📊 详细报告**: 可视化测试结果
- **🚀 易于扩展**: 模块化设计支持新功能