# 整数上采样权重分析

## 关键发现

NPP对于整数上采样（>2x）使用了**修改的插值权重**，而不是标准的双线性插值。

## 权重提取结果

使用简单的[0, 100]源模式，NPP的输出直接表明了有效权重。

### 2x Upscale (工作正常)
```
fx=0.250: NPP=25,  ratio=1.00  ✓ 标准双线性
fx=0.750: NPP=75,  ratio=1.00  ✓ 标准双线性
```
**结论**: 2x使用标准双线性插值

### 3x Upscale
```
fx=0.000: NPP=8,   fx_eff=0.080  (应该是0!)
fx=0.333: NPP=42,  fx_eff=0.420  ratio=1.26
fx=0.667: NPP=75,  fx_eff=0.750  ratio=1.12
```
**异常**: fx=0时NPP不是0，而是8！这意味着NPP添加了一个基础偏移。

### 4x Upscale
```
fx=0.125: NPP=25,  fx_eff=0.250  ratio=2.00
fx=0.375: NPP=50,  fx_eff=0.500  ratio=1.33
fx=0.625: NPP=75,  fx_eff=0.750  ratio=1.20
fx=0.875: NPP=100, fx_eff=1.000  ratio=1.14
```
**模式**: ratio随fx递减: 2.00 → 1.33 → 1.20 → 1.14

### 5x Upscale
```
fx=0.000: NPP=15,  fx_eff=0.150  (应该是0!)
fx=0.200: NPP=35,  fx_eff=0.350  ratio=1.75
fx=0.400: NPP=55,  fx_eff=0.550  ratio=1.37
fx=0.600: NPP=75,  fx_eff=0.750  ratio=1.25
fx=0.800: NPP=95,  fx_eff=0.950  ratio=1.19
```
**模式**:
- fx=0时有15的基础偏移
- ratio随fx递减: 1.75 → 1.37 → 1.25 → 1.19

### 8x Upscale
```
fx=0.062: NPP=25,  fx_eff=0.250  ratio=4.00
fx=0.188: NPP=38,  fx_eff=0.380  ratio=2.03
fx=0.312: NPP=50,  fx_eff=0.500  ratio=1.60
fx=0.438: NPP=63,  fx_eff=0.630  ratio=1.44
fx=0.562: NPP=75,  fx_eff=0.750  ratio=1.33
fx=0.688: NPP=88,  fx_eff=0.880  ratio=1.28
fx=0.812: NPP=100, fx_eff=1.000  ratio=1.23
```
**模式**: ratio从4.00平滑递减到1.23

## 模式总结

### 1. 基础偏移 (fx=0时)

当fx=0时（目标像素正好对齐源像素），NPP不返回源像素值，而是添加了偏移：

| Factor | fx=0时的NPP | 理论值 | 偏移量 | 偏移比例 |
|--------|------------|--------|--------|---------|
| 2x | 25 (fx=0.25) | 25 | 0 | 0% |
| 3x | 8 | 0 | 8 | 8% |
| 4x | - | - | - | - |
| 5x | 15 | 0 | 15 | 15% |
| 8x | - | - | - | - |

**推测**: 偏移量 ≈ 100 / (factor * 某个系数)

### 2. 权重放大 (ratio > 1)

对于所有非零fx，NPP使用的有效fx都大于实际fx，导致ratio > 1。

**关键观察**:
- ratio在fx小时最大，随fx增大而递减
- ratio最大值似乎与factor相关
- ratio趋向于1当fx接近1时

### 3. 线性拟合

所有case都可以用线性公式近似拟合：
```
ratio = a - b * fx
```

其中a和b的值：

| Factor | a (intercept) | b (slope) | 关系 |
|--------|--------------|-----------|------|
| 2x | 5.5 | 6.0 | - |
| 3x | 4.875 | 5.625 | - |
| 4x | 9.143 | 9.143 | a = b |
| 5x | 1.938 | 0.938 | - |
| 8x | 17.067 | 17.067 | a = b |

**观察**: 对于4x和8x，intercept = |slope|

### 4. 可能的公式

基于以上观察，NPP可能使用以下公式：

```cpp
// 对于整数上采样 factor > 2
float base_offset = some_function(factor);  // 当fx≈0时的偏移
float ratio = a - b * fx;  // 线性衰减
float fx_effective = base_offset + fx * ratio;
result = src[x0] * (1 - fx_effective) + src[x1] * fx_effective;
```

## 为什么NPP要这样做？

可能的原因：

1. **避免blockiness**: 标准双线性在大整数上采样时可能产生块状伪影
2. **更平滑的过渡**: 修改权重可以产生更平滑的视觉效果
3. **硬件优化**: 可能是为了GPU硬件实现的效率
4. **数值精度**: 可能与定点运算的舍入行为有关

## 实际影响

- 大整数上采样（3x, 4x, 5x, 8x）的差异主要在边缘和过渡区域
- 最大像素差异：7-11个灰度级
- 视觉上差异较小，但在精确匹配测试中会失败

## 下一步

要完美匹配NPP，需要：

1. 精确确定base_offset的计算公式
2. 精确确定ratio衰减的参数a和b
3. 可能需要考虑舍入行为（定点 vs 浮点）

但考虑到：
- 这是NPP的专有算法细节
- 视觉差异很小
- 只影响特定的大整数上采样场景

**建议**: 对于生产使用，当前的标准双线性实现已经足够。如果需要完美匹配，可以为3x/4x/5x/8x添加特殊处理逻辑。
